name: Deploy Python Environment (Diff Patch)

on:
  push:
    tags:
      - 'env-v*'
  workflow_dispatch:

jobs:
  build-python-env:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          lfs: true

      # 1. HDiffPatch Tool Setup
      - name: Download HDiffPatch Tool
        shell: powershell
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $headers = @{ Authorization = "Bearer $env:GH_TOKEN" }
          $apiUrl = "https://api.github.com/repos/sisong/HDiffPatch/releases"
          
          try {
              $releases = Invoke-RestMethod -Uri $apiUrl -Headers $headers
          } catch {
              Write-Error "Failed to fetch releases list: $_"
              exit 1
          }

          $targetAsset = $null
          $targetTag = ""

          foreach ($release in $releases) {
              $found = $release.assets | Where-Object { $_.name -like "*windows*.zip" -or $_.name -like "*win64*.zip" } | Select-Object -First 1
              if ($found) {
                  $targetAsset = $found
                  $targetTag = $release.tag_name
                  break 
              }
          }
          
          if ($null -eq $targetAsset) {
              Write-Error "FATAL: Could not find any windows asset in recent HDiffPatch releases."
              exit 1
          }

          $downloadUrl = $targetAsset.browser_download_url
          Invoke-WebRequest -Uri $downloadUrl -OutFile "hdiff_tool.zip"
          Expand-Archive -Path "hdiff_tool.zip" -DestinationPath "hdiff_tools" -Force
          Get-ChildItem -Path "hdiff_tools" -Recurse -Filter "hdiffz.exe" | Copy-Item -Destination . -Force
          Get-ChildItem -Path "hdiff_tools" -Recurse -Filter "hpatchz.exe" | Copy-Item -Destination . -Force

      - name: Cache Pip Packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/pip
            wheelhouse
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # 2. Build Python Environment
      - name: Build Pure Isolated Python
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"

          $EnvName = "python-env"
          if (Test-Path $EnvName) { Remove-Item $EnvName -Recurse -Force }
          New-Item -ItemType Directory -Path $EnvName -Force

          # Python Download
          $Url = "https://www.python.org/ftp/python/3.11.9/python-3.11.9-embed-amd64.zip"
          Invoke-WebRequest -Uri $Url -OutFile "python.zip"
          Expand-Archive -Path "python.zip" -DestinationPath $EnvName -Force
          Remove-Item "python.zip" -Force

          Rename-Item -Path "$EnvName\python.exe" -NewName "kiosk_python.exe"
          $PythonExe = "$EnvName\kiosk_python.exe"

          $PthFile = "$EnvName\python311._pth"
          (Get-Content $PthFile) -replace '#import site', 'import site' | Set-Content $PthFile
          
          # Pip Install
          Invoke-WebRequest -Uri "https://bootstrap.pypa.io/get-pip.py" -OutFile "get-pip.py"
          & $PythonExe get-pip.py --no-warn-script-location
          Remove-Item "get-pip.py" -Force

          Write-Host "Installing libraries from requirements.txt..."
          & $PythonExe -m pip install -r requirements.txt --no-warn-script-location --extra-index-url https://download.pytorch.org/whl/cpu
          
          # ----------------------------------------------------------------
          # [NPU Addon] HailoRT Wheel 설치 (libs 폴더 활용)
          # ----------------------------------------------------------------
          Write-Host "Installing HailoRT local wheel..."
          $HailoWheel = Get-ChildItem -Path "libs" -Filter "hailort-*.whl" | Select-Object -First 1
          
          if ($HailoWheel) {
              Write-Host "Found wheel: $($HailoWheel.Name)"
              & $PythonExe -m pip install $HailoWheel.FullName --no-warn-script-location
          } else {
              Write-Error "FATAL: HailoRT .whl file not found in 'libs/' directory."
              exit 1
          }

          if ($LASTEXITCODE -ne 0) { throw "Pip install failed" }

          $PyWin32Dir = "$EnvName\Lib\site-packages\pywin32_system32"
          if (Test-Path $PyWin32Dir) {
              Get-ChildItem -Path $PyWin32Dir -Filter "*.dll" | Copy-Item -Destination $EnvName -Force
          }
          
          # ================================================================
          # [BugFix 1] MeCab 사전 폴더명 보정 (unidic_lite -> unidic)
          # ================================================================
          Write-Host "Fixing MeCab dictionary path..."
          $SitePackages = "$EnvName\Lib\site-packages"
          $UnidicLite = "$SitePackages\unidic_lite"
          $Unidic = "$SitePackages\unidic"
          
          if (Test-Path $UnidicLite) {
              if (-not (Test-Path $Unidic)) {
                  Copy-Item -Path $UnidicLite -Destination $Unidic -Recurse -Force
                  Write-Host "  -> Copied 'unidic_lite' to 'unidic' successfully."
              }
          }

          # ================================================================
          # [BugFix 2] TTS 모델 다운로드 (이게 없으면 Piper/Sherpa 소리 안남!)
          # ================================================================
          Write-Host "Downloading TTS Models..."
          $ModelDir = "$EnvName\tts_models"
          New-Item -ItemType Directory -Path "$ModelDir\piper_models" -Force | Out-Null
          New-Item -ItemType Directory -Path "$ModelDir\sherpa_models\vits-mms-tgl" -Force | Out-Null
          
          & $PythonExe -c @"
          import os, shutil, sys
          try:
              from huggingface_hub import hf_hub_download
          except ImportError:
              print('huggingface_hub not found'); sys.exit(1)

          # 1. Piper Models (Vietnamese, Spanish, French)
          piper_dir = r'$ModelDir\piper_models'
          piper_files = [
              'vi/vi_VN/vivos/x_low/vi_VN-vivos-x_low.onnx', 
              'vi/vi_VN/vivos/x_low/vi_VN-vivos-x_low.onnx.json',
              'es/es_ES/davefx/medium/es_ES-davefx-medium.onnx',
              'es/es_ES/davefx/medium/es_ES-davefx-medium.onnx.json',
              'fr/fr_FR/upmc/medium/fr_FR-upmc-medium.onnx',
              'fr/fr_FR/upmc/medium/fr_FR-upmc-medium.onnx.json'
          ]
          
          print('Downloading Piper models...')
          for fpath in piper_files:
              fname = fpath.split('/')[-1]
              try:
                  hf_hub_download(repo_id='rhasspy/piper-voices', filename=fpath, local_dir=piper_dir, local_dir_use_symlinks=False)
                  print(f' - OK: {fname}')
              except Exception as e:
                  print(f' - FAIL: {fname}')

          # 2. Sherpa Models (Filipino)
          sherpa_dir = r'$ModelDir\sherpa_models\vits-mms-tgl'
          sherpa_files = ['tgl/tokens.txt', 'tgl/model.onnx']
          
          print('Downloading Sherpa models...')
          for fpath in sherpa_files:
              fname = fpath.split('/')[-1]
              try:
                  down_path = hf_hub_download(repo_id='willwade/mms-tts-multilingual-models-onnx', filename=fpath)
                  shutil.copy(down_path, os.path.join(sherpa_dir, fname))
                  print(f' - OK: {fname}')
              except Exception as e:
                  print(f' - FAIL: {fname} ({e})')
          "@
          
          # ================================================================
          # [Changed] STT 모델 설정 (NPU용 HEF 파일 복사)
          # 기존 Sherpa/Vosk 다운로드 로직 삭제됨
          # ================================================================
          Write-Host "Setting up NPU STT Models..."
          
          # api_server.py 복사 (통합 서버)
          if (Test-Path ".\api_server.py") {
              Copy-Item ".\api_server.py" -Destination "$EnvName\api_server.py" -Force
              Write-Host "   -> api_server.py copied."
          }

          $STTModelDir = "$EnvName\models"
          New-Item -ItemType Directory -Path $STTModelDir -Force | Out-Null
          
          # 로컬에 있는 Whisper HEF 모델 복사 (models/whisper_small.hef)
          $LocalHef = "models\whisper_small.hef"
          if (Test-Path $LocalHef) {
              Copy-Item -Path $LocalHef -Destination "$STTModelDir\whisper_small.hef" -Force
              Write-Host "  -> Copied NPU Model: whisper_small.hef"
          } else {
              Write-Error "FATAL: 'models\whisper_small.hef' not found in repo."
              # 필요한 경우 exit 1 처리하여 빌드 중단 가능
              exit 1
          }
          
          # [중요] .dist-info 폴더 삭제하지 않음 (안전모드)
          Get-ChildItem -Path "$EnvName" -Include "__pycache__" -Recurse -Directory | Remove-Item -Recurse -Force

      # 3. Full Zip & Manifest
      - name: Setup Node.js for Manifest
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Generate Manifest
        run: node scripts/generate_manifest.js

      - name: Zip NEW Full Environment
        run: 7z a -mx=9 python-env-full.zip python-env

      # 4. Download Previous Release
      - name: Download Previous Release Asset
        uses: robinraju/release-downloader@v1.8
        continue-on-error: true
        with:
          latest: true
          fileName: "python-env-full.zip"
          out-file-path: "previous_release"

      # 5. Generate HDiff Patch (메모리 옵션 추가됨)
      - name: Generate HDiff Patch
        id: diff
        shell: powershell
        run: |
          $OldFile = "previous_release\python-env-full.zip"
          $NewFile = "python-env-full.zip"
          $PatchFile = "patch.hdiff"

          if (Test-Path $OldFile) {
            Write-Host "Found previous version. Generating diff patch..."
            # [Fix] -s-64 옵션 추가 (메모리 부족 방지)
            ./hdiffz.exe -c-zstd -s-64 -f $OldFile $NewFile $PatchFile
          
            if (Test-Path $PatchFile) {
               $Size = (Get-Item $PatchFile).Length / 1MB
               Write-Host "Patch generated! Size: $("{0:N2}" -f $Size) MB"
               echo "PATCH_EXISTS=true" >> $env:GITHUB_ENV
            } else {
               Write-Host "Failed to generate patch."
               echo "PATCH_EXISTS=false" >> $env:GITHUB_ENV
            }
          } else {
            Write-Host "No previous version found."
            echo "PATCH_EXISTS=false" >> $env:GITHUB_ENV
          }

      # 6. Upload
      - name: Generate SHA256 Hashes
        shell: powershell
        run: |
          $hashFull = (Get-FileHash python-env-full.zip -Algorithm SHA256).Hash
          "Full: $hashFull" | Out-File -Encoding ASCII hash.txt -Append
          if ($env:PATCH_EXISTS -eq 'true') {
            $hashPatch = (Get-FileHash patch.hdiff -Algorithm SHA256).Hash
            "Patch: $hashPatch" | Out-File -Encoding ASCII hash.txt -Append
          }

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            python-env-full.zip
            patch.hdiff
            hpatchz.exe
            manifest.json
            hash.txt
          prerelease: false
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}