name: Deploy Python Environment

on:
  push:
    tags:
      - 'env-v*'
  workflow_dispatch:

jobs:
  build-python-env:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # [ìºì‹œ] requirements.txtê°€ ì•ˆ ë°”ë€Œë©´ ë‹¤ìš´ë¡œë“œ ìƒëµ
      - name: Cache Pip Packages
        uses: actions/cache@v3
        id: pip-cache
        with:
          path: |
            ~/.cache/pip
            wheelhouse
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Setup System Python (For Compilation)
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          architecture: 'x64'

      - name: Build Wheels for C-Extensions
        shell: powershell
        run: |
          if (-not (Test-Path "wheelhouse")) { New-Item -ItemType Directory -Path "wheelhouse" -Force }
          python -m pip wheel simpleaudio eunjeon --wheel-dir=./wheelhouse

      - name: Build Pure Isolated Python
        shell: powershell
        run: |
          $EnvName = "python-env"
          if (Test-Path $EnvName) { Remove-Item $EnvName -Recurse -Force }
          New-Item -ItemType Directory -Path $EnvName -Force

          # 1. íŒŒì´ì¬ ì„ë² ë””ë“œ ë‹¤ìš´ë¡œë“œ
          $Url = "https://www.python.org/ftp/python/3.11.9/python-3.11.9-embed-amd64.zip"
          Invoke-WebRequest -Uri $Url -OutFile "python.zip"
          Expand-Archive -Path "python.zip" -DestinationPath $EnvName -Force
          Remove-Item "python.zip" -Force

          # 2. ì‹¤í–‰ íŒŒì¼ëª… ë³€ê²½
          Rename-Item -Path "$EnvName\python.exe" -NewName "kiosk_python.exe"
          $PythonExe = "$EnvName\kiosk_python.exe"

          # 3. ._pth íŒŒì¼ ìˆ˜ì •
          $PthFile = "$EnvName\python311._pth"
          (Get-Content $PthFile) -replace '#import site', 'import site' | Set-Content $PthFile
          
          # 4. pip ì„¤ì¹˜
          Invoke-WebRequest -Uri "https://bootstrap.pypa.io/get-pip.py" -OutFile "get-pip.py"
          & $PythonExe get-pip.py --no-warn-script-location
          Remove-Item "get-pip.py" -Force

          # 5. ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
          Write-Host "Installing libraries..."
          & $PythonExe -m pip install simpleaudio eunjeon --no-index --find-links=./wheelhouse --no-warn-script-location
          & $PythonExe -m pip install -r requirements.txt --no-warn-script-location --extra-index-url https://download.pytorch.org/whl/cpu
          
          # 6. UniDic ë‹¤ìš´ë¡œë“œ (ì´ê²Œ ìš©ëŸ‰ ì—„ì²­ í½ë‹ˆë‹¤)
          Write-Host "Downloading UniDic Dictionary..."
          & $PythonExe -m unidic download

          # 7. PyWin32 DLL ë³µì‚¬ ë° ì •ë¦¬
          $PyWin32Dir = "$EnvName\Lib\site-packages\pywin32_system32"
          if (Test-Path $PyWin32Dir) {
              Get-ChildItem -Path $PyWin32Dir -Filter "*.dll" | Copy-Item -Destination $EnvName -Force
          }
          Get-ChildItem -Path "$EnvName" -Include "__pycache__" -Recurse -Directory | Remove-Item -Recurse -Force

      # [Manifest ì¤€ë¹„] Node.js ì„¤ì¹˜
      - name: Setup Node.js for Manifest
        uses: actions/setup-node@v3
        with:
          node-version: 20

      # [Manifest ìƒì„±] ì‚­ì œí•˜ê¸° ì „ì— ì „ì²´ íŒŒì¼ ê¸°ì¤€ìœ¼ë¡œ í•´ì‹œ ìƒì„±
      - name: Generate Manifest
        run: node scripts/generate_manifest.js

      # [1] Full ë²„ì „ ì••ì¶• (ì›ë³¸ ê·¸ëŒ€ë¡œ)
      - name: Zip Full Environment
        run: 7z a -mx=9 python-env-full.zip python-env

      # [2] Patch ìƒì„±ì„ ìœ„í•œ ê°•ë ¥ ë‹¤ì´ì–´íŠ¸ (ë¬¼ë¦¬ì  ì‚­ì œ)
      - name: Slim down for Patch
        shell: powershell
        run: |
          Write-Host "ğŸ”¥ Removing heavy libraries for Patch version..."
          $site_packages = "python-env\Lib\site-packages"

          # 1. AI & Deep Learning (ê°€ì¥ ë¬´ê±°ì›€)
          if (Test-Path "$site_packages\torch") { Remove-Item "$site_packages\torch" -Recurse -Force }
          if (Test-Path "$site_packages\torchaudio") { Remove-Item "$site_packages\torchaudio" -Recurse -Force }
          if (Test-Path "$site_packages\torchvision") { Remove-Item "$site_packages\torchvision" -Recurse -Force }
          # nvidia í´ë”ê°€ ìˆ˜ë°±MB ì°¨ì§€í•¨ (CUDA ê´€ë ¨)
          if (Test-Path "$site_packages\nvidia") { Remove-Item "$site_packages\nvidia" -Recurse -Force }
          
          # Transformers & HF
          if (Test-Path "$site_packages\transformers") { Remove-Item "$site_packages\transformers" -Recurse -Force }
          if (Test-Path "$site_packages\tokenizers") { Remove-Item "$site_packages\tokenizers" -Recurse -Force }
          if (Test-Path "$site_packages\huggingface_hub") { Remove-Item "$site_packages\huggingface_hub" -Recurse -Force }

          # 2. ë°ì´í„° ê³¼í•™ & ì‚¬ì „ ë°ì´í„°
          if (Test-Path "$site_packages\numpy") { Remove-Item "$site_packages\numpy" -Recurse -Force }
          if (Test-Path "$site_packages\pandas") { Remove-Item "$site_packages\pandas" -Recurse -Force }
          if (Test-Path "$site_packages\scipy") { Remove-Item "$site_packages\scipy" -Recurse -Force }
          if (Test-Path "$site_packages\scikit_learn") { Remove-Item "$site_packages\scikit_learn" -Recurse -Force }
          if (Test-Path "$site_packages\sklearn") { Remove-Item "$site_packages\sklearn" -Recurse -Force }
          
          # UniDic ì‚¬ì „ ë°ì´í„° (ì—„ì²­ í¼)
          if (Test-Path "$site_packages\unidic") { Remove-Item "$site_packages\unidic" -Recurse -Force }
          
          # 3. ê¸°íƒ€ ë¬´ê±°ìš´ ë…€ì„ë“¤
          if (Test-Path "$site_packages\PIL") { Remove-Item "$site_packages\PIL" -Recurse -Force }
          if (Test-Path "$site_packages\matplotlib") { Remove-Item "$site_packages\matplotlib" -Recurse -Force }
          
          # 4. ì°Œêº¼ê¸° ì œê±°
          Get-ChildItem -Path "python-env" -Include "__pycache__" -Recurse -Directory | Remove-Item -Recurse -Force
          Get-ChildItem -Path "python-env" -Include "*.dist-info" -Recurse -Directory | Remove-Item -Recurse -Force
          
          Write-Host "âœ… Cleanup complete. Ready to zip patch."

      # [3] Patch ë²„ì „ ì••ì¶• (ì´ì œ ì§„ì§œ ê°€ë²¼ì›€)
      - name: Zip Patch Environment
        run: 7z a -mx=9 python-env-patch.zip python-env

      - name: Generate SHA256 Hashes
        shell: powershell
        run: |
          $hashFull = (Get-FileHash python-env-full.zip -Algorithm SHA256).Hash
          $hashPatch = (Get-FileHash python-env-patch.zip -Algorithm SHA256).Hash
          "Full: $hashFull" | Out-File -Encoding ASCII hash.txt -Append
          "Patch: $hashPatch" | Out-File -Encoding ASCII hash.txt -Append

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            python-env-full.zip
            python-env-patch.zip
            manifest.json
            hash.txt
          prerelease: false
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}