name: Deploy Python Environment

on:
  push:
    tags:
      - 'env-v*'

jobs:
  build-python-env:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # [1단계] 시스템 파이썬 세팅
      - name: Setup System Python (For Compilation)
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          architecture: 'x64'

      # [2단계] 휠 빌드
      - name: Build Wheels for C-Extensions
        shell: powershell
        run: |
          New-Item -ItemType Directory -Path "wheelhouse" -Force
          
          Write-Host "Building difficult packages..."
          python -m pip wheel simpleaudio eunjeon --wheel-dir=./wheelhouse

      # [3단계] 순정 임베디드 파이썬 구축
      - name: Build Pure Isolated Python
        shell: powershell
        run: |
          # --- 1. 작업 폴더 준비 ---
          $EnvName = "python-env"
          if (Test-Path $EnvName) { Remove-Item $EnvName -Recurse -Force }
          New-Item -ItemType Directory -Path $EnvName -Force

          # --- 2. 순정 파이썬 다운로드 ---
          $Url = "https://www.python.org/ftp/python/3.11.9/python-3.11.9-embed-amd64.zip"
          Invoke-WebRequest -Uri $Url -OutFile "python.zip"
          Expand-Archive -Path "python.zip" -DestinationPath $EnvName -Force
          Remove-Item "python.zip" -Force

          # --- 3. 실행 파일 이름 변경 ---
          $PythonExe = "$EnvName\kiosk_python.exe"
          Rename-Item -Path "$EnvName\python.exe" -NewName "kiosk_python.exe"

          # --- 4. ._pth 파일 수정 ---
          $PthFile = "$EnvName\python311._pth"
          (Get-Content $PthFile) -replace '#import site', 'import site' | Set-Content $PthFile
          
          # --- 5. pip 설치 ---
          Invoke-WebRequest -Uri "https://bootstrap.pypa.io/get-pip.py" -OutFile "get-pip.py"
          & $PythonExe get-pip.py --no-warn-script-location
          Remove-Item "get-pip.py" -Force

          # --- 6. 라이브러리 설치 ---
          Write-Host "Installing from pre-built wheels..."
          
          # (A) 컴파일해둔 휠 먼저 설치
          & $PythonExe -m pip install simpleaudio eunjeon --no-index --find-links=./wheelhouse --no-warn-script-location
          
          # (B) 나머지 라이브러리 설치
          & $PythonExe -m pip install -r requirements.txt --no-warn-script-location --extra-index-url https://download.pytorch.org/whl/cpu

          # [추가됨] UniDic 사전 데이터 다운로드 (딱 이것만 추가함)
          Write-Host "Downloading UniDic Dictionary..."
          & $PythonExe -m unidic download

          # --- 7. PyWin32 DLL 복사 ---
          $PyWin32Dir = "$EnvName\Lib\site-packages\pywin32_system32"
          if (Test-Path $PyWin32Dir) {
              Get-ChildItem -Path $PyWin32Dir -Filter "*.dll" | Copy-Item -Destination $EnvName -Force
          }

      - name: Zip python-env folder
        run: 7z a python-env.zip python-env

      # [추가] 무결성 검증을 위한 SHA256 해시 파일 생성
      - name: Generate SHA256 Hash
        shell: powershell
        run: |
          $hash = (Get-FileHash python-env.zip -Algorithm SHA256).Hash
          $hash | Out-File -Encoding ASCII hash.txt
          Write-Host "Generated Hash: $hash"

      # [수정] 업로드할 파일 목록에 hash.txt 추가
      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            python-env.zip
            hash.txt
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}